name: Dev Deployment Simulation

#Git
on:
  push:
    branches: [ "main", "docker-setup" ]
  pull_request:
    branches: [ "main", "docker-setup" ]

jobs:
  dev-sim:
    name: Simulate Dev Deployment
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Backend
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install backend dependencies
        working-directory: backend
        run: npm install
      - name: Run backend tests
        working-directory: backend
        run: npm test

      # Frontend
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install
      - name: Run frontend tests
        working-directory: frontend
        run: npm test

      # Build and start Docker Compose
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build backend Docker image
        run: docker build -t backend-dev ./backend
      - name: Build frontend Docker image
        run: docker build -t frontend-dev ./frontend
      - name: Start dev environment
        run: docker compose -f docker-compose.ci.yml up -d --build
      - name: Wait for services
        run: sleep 15
      - name: Show running containers
        run: docker ps

      # Integration check
      - name: Integration check
        run: |
          curl -f http://localhost:5000/health || exit 1
          curl -f http://localhost:3000 || exit 1

      # Teardown
      - name: Stop dev environment
        if: always()
        run: docker compose -f docker-compose.ci.yml down
